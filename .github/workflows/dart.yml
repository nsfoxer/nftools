# Dart + Rust + Flutter macOS M4 构建流程
name: Rust + Dart + Flutter (macOS M4 Release)

on:
  push:
    branches: [ "work_utils" ] # 兼容main分支，方便测试
  pull_request:
    branches: [ "work_utils" ]

jobs:
  build-macos-release:
    runs-on: macos-14 # 指定macOS 14（Sonoma），M4标配，排队更少
    permissions:
      contents: read
      actions: read
      # 新增：允许访问artifact（上传产物需要）
      packages: write

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 拉取完整历史，避免依赖缺失

      # ====================== 1. 前置：安装macOS编译依赖 =======================
      - name: 安装Xcode命令行工具
        run: |
          sudo xcode-select -s /Applications/Xcode_15.app/Contents/Developer
          xcode-select --install || true # 已安装则忽略

      # ====================== 2. Rust 编译（M4原生）======================
      - name: 安装Rust工具链（适配M4）
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy
          targets: aarch64-apple-darwin

      - name: 安装rinf依赖（带重试）
        run: cargo install rinf || cargo install rinf

      # ====================== 3. Dart & Flutter 环境配置 =======================
      - name: 安装Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          # 配置Flutter镜像（加速下载）
          flutter-cache: true
          cache-key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}

      - name: 验证Flutter环境（适配M4）
        run: |
          flutter doctor -v
          flutter config --enable-macos-desktop
          flutter precache --macos # 预下载macOS编译依赖

      - name: 安装Flutter/Dart依赖
        run: flutter pub get
        working-directory: ./ # 确认是Flutter项目根目录

      # ====================== 4. 运行Dart脚本 =======================
      - name: 执行Dart脚本
        run: dart enhance_rinf.dart
        working-directory: ./ # 确认脚本在该目录下

      # ====================== 5. 编译Flutter macOS Release版本 =======================
      - name: Flutter构建macOS Release（M4）
        run: flutter build macos --release --verbose
        working-directory: ./
        env:
          ARCHS: arm64
          MACOSX_DEPLOYMENT_TARGET: 14.0
          # 新增：rinf所需的Rust路径
          RUST_BACKTRACE: 1

      # ====================== 6. 上传产物 =======================
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: macos-m4-release
          path: |
            ./build/macos/Build/Products/Release/
          # 新增：保留90天，方便下载
          retention-days: 90
